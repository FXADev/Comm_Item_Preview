name: Nightly ETL Process

on:
  schedule:
    # Run at 5:00 AM EST (9:00 UTC)
    - cron: '0 9 * * *'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  run-etl:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.lock
        
    - name: Install SQL Server ODBC Driver
      run: |
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        curl https://packages.microsoft.com/config/ubuntu/20.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        sudo apt-get update
        sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18
        sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18
        echo 'export PATH="$PATH:/opt/mssql-tools18/bin"' >> ~/.bashrc
        
    - name: Get start time
      id: start-time
      run: echo "startTime=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
      
    - name: Set job outputs
      id: job-info
      run: |
        echo "repository=${{ github.repository }}" >> $GITHUB_OUTPUT
        echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT

    - name: Run ETL process
      env:
        # Use GitHub secrets for all credentials
        REDSHIFT_HOST: ${{ secrets.REDSHIFT_HOST }}
        REDSHIFT_PORT: ${{ secrets.REDSHIFT_PORT }}
        REDSHIFT_DATABASE: ${{ secrets.REDSHIFT_DATABASE }}
        REDSHIFT_USER: ${{ secrets.REDSHIFT_USER }}
        REDSHIFT_PASSWORD: ${{ secrets.REDSHIFT_PASSWORD }}
        REDSHIFT_SCHEMA: ${{ secrets.REDSHIFT_SCHEMA }}
        SF_USERNAME: ${{ secrets.SF_USERNAME }}
        SF_PASSWORD: ${{ secrets.SF_PASSWORD }}
        SF_SECURITY_TOKEN: ${{ secrets.SF_SECURITY_TOKEN }}
        SQL_SERVER: ${{ secrets.SQL_SERVER }}
        SQL_DATABASE: ${{ secrets.SQL_DATABASE }}
        SQL_USERNAME: ${{ secrets.SQL_USERNAME }}
        SQL_PASSWORD: ${{ secrets.SQL_PASSWORD }}
        SQL_DRIVER: ${{ secrets.SQL_DRIVER }}
      run: |
        python run_etl.py
        
    # Send email notification on successful completion of the ETL process
    - name: Notify on success
      if: success()
      uses: dawidd6/action-send-mail@v3
      with:
        # Gmail SMTP configuration
        server_address: smtp.gmail.com
        server_port: 587
        secure: true
        # Use the exact secret names created in GitHub
        username: ${{ secrets.smtp_username }}
        password: ${{ secrets.smtp_password }}
        subject: "✅ Commission Preview ETL Success"
        body: |
          ## ✅ Commission Preview ETL Success
          
          The nightly ETL process completed successfully.
          
          **Repository:** ${{ steps.job-info.outputs.repository }}
          **Branch:** ${{ steps.job-info.outputs.branch }}
          **Start time:** ${{ steps.start-time.outputs.startTime }}
          **End time:** $(date +'%Y-%m-%d %H:%M:%S UTC')
          
          ### View the full run details:
          https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        # Send emails to all recipients in the notification list
        to: ${{ secrets.NOTIFICATION_EMAILS }}
        from: Commission ETL GitHub Action
        convert_markdown: true
        
    # Send email notification when ETL process fails
    - name: Notify on failure
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        # Gmail SMTP configuration
        server_address: smtp.gmail.com
        server_port: 587
        secure: true
        # Use the exact secret names created in GitHub
        username: ${{ secrets.smtp_username }}
        password: ${{ secrets.smtp_password }}
        subject: "⚠️ Commission Preview ETL Failure"
        body: |
          ## ⚠️ Commission Preview ETL Failure
          
          The nightly ETL process failed.
          
          **Repository:** ${{ steps.job-info.outputs.repository }}
          **Branch:** ${{ steps.job-info.outputs.branch }}
          **Start time:** ${{ steps.start-time.outputs.startTime }}
          **End time:** $(date +'%Y-%m-%d %H:%M:%S UTC')
          
          ### Error Information
          Please check the GitHub Actions logs for detailed error messages.
          
          ### View the full run details:
          https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        # Send emails to all recipients in the notification list
        to: ${{ secrets.NOTIFICATION_EMAILS }}
        from: Commission ETL GitHub Action
        convert_markdown: true
